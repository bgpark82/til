name: Daily TIL Summary

# ë§¤ì¼ ì•„ì¹¨ 9ì‹œ(ë² ë¥¼ë¦° ì‹œê°„)ì— ì‹¤í–‰ë˜ë©°, ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
on:
  schedule:
    - cron: '0 8 * * *'  # UTC+1(ë² ë¥¼ë¦°) ê¸°ì¤€ ì˜¤ì „ 9ì‹œ
  workflow_dispatch:      # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜

jobs:
  send-daily-summary:
    runs-on: ubuntu-latest
    
    steps:
      # ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œë¥¼ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout repository
        uses: actions/checkout@v2

      # ë‹¹ì¼ ë³€ê²½ëœ íŒŒì¼ í™•ì¸ ë° ìš”ì•½ ìƒì„±
      - name: Get today's changed files
        id: changed-files
        env:
          TZ: 'Europe/Berlin'  # ë² ë¥¼ë¦° ì‹œê°„ëŒ€ ì§ì ‘ ì„¤ì •
        run: |
          TODAY=$(date +%Y-%m-%d)
          
          # ë‹¹ì¼ ìˆ˜ì •ëœ md íŒŒì¼ ì°¾ê¸° (.github í´ë” ì œì™¸)
          CHANGES=$(find . -name "*.md" -not -path "./.github/*" -type f -newermt "${TODAY} 00:00" ! -newermt "${TODAY} 23:59" -print)
          
          # ë³€ê²½ëœ íŒŒì¼ì´ ìˆëŠ” ê²½ìš°
          if [ -n "$CHANGES" ]; then
            # ë©€í‹°ë¼ì¸ í™˜ê²½ë³€ìˆ˜ ì‹œì‘
            echo "SUMMARY<<EOF" >> $GITHUB_ENV
            # ë©”ì‹œì§€ í—¤ë” ì¶”ê°€
            echo "ğŸ“š ì˜¤ëŠ˜ì˜ TIL ìš”ì•½ (${TODAY})" >> $GITHUB_ENV
            echo "" >> $GITHUB_ENV
            
            # ê° ë³€ê²½ëœ íŒŒì¼ì— ëŒ€í•´
            while IFS= read -r file; do
              if [ -f "$file" ]; then
                echo "---" >> $GITHUB_ENV
                # íŒŒì¼ì˜ ì²« ì¤„(ì œëª©) ì¶”ì¶œí•˜ì—¬ '#' ì œê±° í›„ '*'ë¡œ ê°ì‹¸ì„œ ì¶œë ¥
                head -n 1 "$file" | sed 's/^#\s*/ğŸ¯ \*/' | sed 's/$/\*/' >> $GITHUB_ENV
                
                # íŒŒì¼ ê²½ë¡œì—ì„œ ./ ì œê±°í•˜ê³  ì´íƒ¤ë¦­ì²´ë¡œ ì¶œë ¥
                CLEAN_PATH=$(echo "$file" | sed 's|^\./||')
                echo "_${CLEAN_PATH}_" >> $GITHUB_ENV
                
                # íŒŒì¼ ë‚´ìš© ì „ì²´ë¥¼ ê°€ì ¸ì™€ì„œ ì²« ì¤„(ì œëª©)ì„ ì œì™¸í•˜ê³  ì¶œë ¥
                echo "> $(tail -n +2 "$file")" | sed 's/^/> /' >> $GITHUB_ENV
                echo "" >> $GITHUB_ENV
              fi
            done <<< "$CHANGES"
            # ë©€í‹°ë¼ì¸ í™˜ê²½ë³€ìˆ˜ ì¢…ë£Œ
            echo "EOF" >> $GITHUB_ENV
          else
            # ë³€ê²½ëœ íŒŒì¼ì´ ì—†ëŠ” ê²½ìš°
            echo "SUMMARY=ì˜¤ëŠ˜ì€ ìƒˆë¡œìš´ TILì´ ì—†ìŠµë‹ˆë‹¤. ğŸ˜…" >> $GITHUB_ENV
          fi

      # Slackìœ¼ë¡œ ìš”ì•½ ì „ì†¡
      - name: Send summary to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # curlì„ ì‚¬ìš©í•˜ì—¬ Slack webhookìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"${{ env.SUMMARY }}\"
            }" \
            $SLACK_WEBHOOK_URL





