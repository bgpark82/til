name: Daily TIL Summary

# ë§¤ì¼ ì•„ì¹¨ 9ì‹œ(ë² ë¥¼ë¦° ì‹œê°„)ì— ì‹¤í–‰ë˜ë©°, ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
on:
  schedule:
    - cron: '0 8 * * *'  # UTC+1(ë² ë¥¼ë¦°) ê¸°ì¤€ ì˜¤ì „ 9ì‹œ
  workflow_dispatch:      # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜

jobs:
  send-daily-summary:
    runs-on: ubuntu-latest
    
    steps:
      # ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œë¥¼ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì˜´

      # ì „ë‚  ë³€ê²½ëœ íŒŒì¼ í™•ì¸ ë° ìš”ì•½ ìƒì„±
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openai

      - name: Get and summarize yesterday's changes
        id: changed-files
        env:
          TZ: 'Europe/Berlin'
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import subprocess
          from datetime import datetime, timedelta
          import openai

          # OpenAI API ì„¤ì •
          openai.api_key = os.getenv('OPENAI_API_KEY')

          def get_file_content(file_path):
              with open(file_path, 'r', encoding='utf-8') as f:
                  return f.read()

          # ì–´ì œ ë‚ ì§œ êµ¬í•˜ê¸°
          today = datetime.now()
          yesterday = (today - timedelta(days=1)).strftime('%Y-%m-%d')
          
          # ì–´ì œ ë³€ê²½ëœ íŒŒì¼ ì°¾ê¸°
          cmd = f"git log --since='{yesterday} 00:00:00' --until='{yesterday} 23:59:59' --name-only --format='' | grep '\\.md$' | grep -v '^\.github/' | sort -u"
          changes = subprocess.getoutput(cmd).strip().split('\n')
          
          if changes and changes[0]:
              summary = f"ğŸ“š *ì˜¤ëŠ˜ì˜ TIL ìš”ì•½ ({today.strftime('%Y-%m-%d')})*\n\n"
              
              for file in changes:
                  if os.path.exists(file):
                      content = get_file_content(file)
                      
                      # ChatGPT APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë‚´ìš© ìš”ì•½
                      response = openai.ChatCompletion.create(
                          model="gpt-3.5-turbo",
                          messages=[
                              {"role": "system", "content": "ë§ˆí¬ë‹¤ìš´ ë¬¸ì„œì˜ ë‚´ìš©ì„ 2-3ë¬¸ì¥ìœ¼ë¡œ ê°„ë‹¨íˆ ìš”ì•½í•´ì£¼ì„¸ìš”."},
                              {"role": "user", "content": content}
                          ]
                      )
                      
                      ai_summary = response.choices[0].message.content
                      
                      # íŒŒì¼ì˜ ì²« ì¤„(ì œëª©)
                      title = content.split('\n')[0].replace('#', '').strip()
                      
                      summary += f"---\n"
                      summary += f"ğŸ¯ *{title}*\n"
                      summary += f"_{file}_\n"
                      summary += f"> {ai_summary}\n\n"
          else:
              summary = "ì˜¤ëŠ˜ì€ ìƒˆë¡œìš´ TILì´ ì—†ìŠµë‹ˆë‹¤. ğŸ˜…"

          # GitHub Actions í™˜ê²½ ë³€ìˆ˜ë¡œ ì €ì¥
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"SUMMARY<<EOF\n{summary}\nEOF\n")
          EOF

      # Slackìœ¼ë¡œ ìš”ì•½ ì „ì†¡
      - name: Send summary to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # curlì„ ì‚¬ìš©í•˜ì—¬ Slack webhookìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\": \"${{ env.SUMMARY }}\"}" \
            $SLACK_WEBHOOK_URL





