name: Daily TIL Summary

# ë§¤ì¼ ì•„ì¹¨ 9ì‹œ(ë² ë¥¼ë¦° ì‹œê°„)ì— ì‹¤í–‰ë˜ë©°, ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
on:
  schedule:
    - cron: '0 8 * * *'  # UTC+1(ë² ë¥¼ë¦°) ê¸°ì¤€ ì˜¤ì „ 9ì‹œ
  workflow_dispatch:      # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜

jobs:
  send-daily-summary:
    runs-on: ubuntu-latest
    
    steps:
      # ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œë¥¼ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì˜´

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openai
          sudo apt-get update
          sudo apt-get install -y jq  # jq ì„¤ì¹˜ ì¶”ê°€

      # ì „ë‚  ë³€ê²½ëœ íŒŒì¼ í™•ì¸ ë° ìš”ì•½ ìƒì„±
      - name: Get yesterday's changed files and summarize
        id: changed-files
        env:
          TZ: 'Europe/Berlin'
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          TODAY=$(date +%Y-%m-%d)
          YESTERDAY=$(date -d "yesterday" +%Y-%m-%d)
          
          # git logë¥¼ ì‚¬ìš©í•˜ì—¬ ì–´ì œ ë‚ ì§œì˜ ëª¨ë“  ë³€ê²½ì‚¬í•­ í™•ì¸
          CHANGES=$(git log --since="$YESTERDAY 00:00:00" --until="$YESTERDAY 23:59:59" --name-only --format="" | grep '\.md$' | grep -v '^\.github/' | sort -u)
          
          # ë³€ê²½ëœ íŒŒì¼ì´ ìˆëŠ” ê²½ìš°
          if [ -n "$CHANGES" ]; then
            # ì„ì‹œ íŒŒì¼ì— ìš”ì•½ ë‚´ìš© ì €ì¥
            TEMP_FILE=$(mktemp)
            
            # í—¤ë” ì¶”ê°€
            echo "ğŸ“š *ì˜¤ëŠ˜ì˜ TIL ìš”ì•½ (${TODAY})*" > "$TEMP_FILE"
            echo "" >> "$TEMP_FILE"
            
            # ê° ë³€ê²½ëœ íŒŒì¼ì— ëŒ€í•´
            while IFS= read -r file; do
              if [ -f "$file" ]; then
                echo "---" >> "$TEMP_FILE"
                
                # íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ìš”ì•½ ìƒì„±
                RESULT=$(python .github/scripts/summarize.py "$file")
                
                # JSON ê²°ê³¼ì—ì„œ í•„ìš”í•œ ì •ë³´ ì¶”ì¶œ
                TITLE=$(echo "$RESULT" | jq -r '.title')
                PATH=$(echo "$RESULT" | jq -r '.path')
                SUMMARY=$(echo "$RESULT" | jq -r '.summary')
                
                echo "ğŸ¯ *${TITLE}*" >> "$TEMP_FILE"
                echo "_${PATH}_" >> "$TEMP_FILE"
                echo "> ${SUMMARY}" >> "$TEMP_FILE"
                echo "" >> "$TEMP_FILE"
              fi
            done <<< "$CHANGES"
            
            # ì„ì‹œ íŒŒì¼ì˜ ë‚´ìš©ì„ GITHUB_ENVì— ì„¤ì •
            echo "SUMMARY<<EOF" >> $GITHUB_ENV
            cat "$TEMP_FILE" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            # ì„ì‹œ íŒŒì¼ ì‚­ì œ
            rm "$TEMP_FILE"
          else
            # ë³€ê²½ëœ íŒŒì¼ì´ ì—†ëŠ” ê²½ìš°
            echo "SUMMARY=ì–´ì œëŠ” ìƒˆë¡œìš´ TILì´ ì—†ì—ˆìŠµë‹ˆë‹¤. ğŸ˜…" >> $GITHUB_ENV
          fi

      # Slackìœ¼ë¡œ ìš”ì•½ ì „ì†¡
      - name: Send summary to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # curlì„ ì‚¬ìš©í•˜ì—¬ Slack webhookìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"${{ env.SUMMARY }}\"
            }" \
            $SLACK_WEBHOOK_URL





