name: Daily TIL Summary
 
# λ§¤μΌ μ•„μΉ¨ 9μ‹(λ² λ¥Όλ¦° μ‹κ°„)μ— μ‹¤ν–‰λλ©°, μλ™ μ‹¤ν–‰λ„ κ°€λ¥ν•λ„λ΅ μ„¤μ •
on:
  schedule:
    - cron: '0 8 * * *'  # UTC+1(λ² λ¥Όλ¦°) κΈ°μ¤€ μ¤μ „ 9μ‹
  workflow_dispatch:      # μλ™ μ‹¤ν–‰ μµμ…

jobs:
  send-daily-summary:
    runs-on: ubuntu-latest

    steps:
      # λ¦¬ν¬μ§€ν† λ¦¬ μ½”λ“λ¥Ό κ°€μ Έμ¤κΈ°
      - name: Checkout repository
        uses: actions/checkout@v2

      # λ‹ΉμΌ λ³€κ²½λ νμΌ ν™•μΈ λ° μ”μ•½ μƒμ„±
      - name: Get today's changed files
        id: changed-files
        env:
          TZ: 'Europe/Berlin'  # λ² λ¥Όλ¦° μ‹κ°„λ€ μ§μ ‘ μ„¤μ •
        run: |
          # ======================= DATE =======================
          # date: λ‚ μ§ κ΄€λ ¨ λ…λ Ήμ–΄
          # -d "yesterday": μ–΄μ  λ‚ μ§λ¥Ό μ§€μ •ν•λ” μµμ…
          # +%Y: 4μλ¦¬ μ—°λ„
          # +%m: 2μλ¦¬ μ›”
          # +%d: 2μλ¦¬ μΌ
          # +%Y-%m-%d: YYYY-MM-DD ν•μ‹μΌλ΅ μ¶λ ¥
          TODAY=$(date -d "yesterday" +%Y-%m-%d)
          echo "μ–΄μ  λ‚ μ§: $TODAY" # μ–΄μ  λ‚ μ§: 2024-01-16
          
          # ======================= CHANGES =======================
          # λ‹ΉμΌ μμ •λ md νμΌ μ°ΎκΈ° (.github ν΄λ” μ μ™Έ)
          # μ¤λ ν•λ£¨λ™μ• μμ •λ .md νμΌλ“¤μ„ μ°Ύμµλ‹λ‹¤
          # κ²°κ³Ό: 
          # - .github ν΄λ”λ¥Ό μ μ™Έν• λ¨λ“  .md νμΌ μ¤‘
          # - μ¤λ 00:00 ~ 23:59 μ‚¬μ΄μ— μμ •λ νμΌλ“¤μ κ²½λ΅κ°€ μ¶λ ¥λ©λ‹λ‹¤
          # - μ: ./ai/langchain.md
          #      ./python/decorator.md 
          
          # git diff: λ³€κ²½λ νμΌ ν™•μΈ
          # --name-only: νμΌ μ΄λ¦„λ§ μ¶λ ¥
          # --diff-filter=M: Modified(μμ •λ) νμΌλ§ ν•„ν„°λ§
          # --since="${TODAY} 00:00": μ¤λ 00:00λ¶€ν„°
          # --until="${TODAY} 23:59": μ¤λ 23:59κΉμ§€
          # -- "*.md": .md νμΌλ§ κ²€μƒ‰
          # | grep -v "^.github/": .github λ””λ ‰ν† λ¦¬ μ μ™Έ
          CHANGES=$(git diff --name-only --diff-filter=M --since="${TODAY} 00:00" --until="${TODAY} 23:59" -- "*.md" | grep -v "^.github/")
          echo "λ³€κ²½λ νμΌ λ©λ΅: $CHANGES"
          # "μμ‹ κ²°κ³Ό: ./ai/langchain.md"
          
          # ======================= SUMMARY =======================
          # λ³€κ²½λ νμΌμ΄ μλ” κ²½μ°
          if [ -n "$CHANGES" ]; then
            # λ©€ν‹°λΌμΈ ν™κ²½λ³€μ μ‹μ‘
            echo "SUMMARY<<EOF" >> $GITHUB_ENV
            # λ©”μ‹μ§€ ν—¤λ” μ¶”κ°€
            echo "π“ μ¤λμ TIL μ”μ•½ (${TODAY})" >> $GITHUB_ENV
            
            echo "" >> $GITHUB_ENV
            
            # κ° λ³€κ²½λ νμΌμ— λ€ν•΄
            while IFS= read -r file; do
              if [ -f "$file" ]; then
                echo "---" >> $GITHUB_ENV
                # νμΌμ μ²« μ¤„(μ λ©) μ¶”μ¶ν•μ—¬ '#' μ κ±° ν›„ '*'λ΅ κ°μ‹Έμ„ μ¶λ ¥
                head -n 1 "$file" | sed 's/^#\s*/\*/' | sed 's/$/\*/' >> $GITHUB_ENV
                
                # νμΌ κ²½λ΅μ—μ„ ./ μ κ±°ν•κ³  μ΄νƒ¤λ¦­μ²΄λ΅ μ¶λ ¥
                CLEAN_PATH=$(echo "$file" | sed 's|^\./||')
                echo "_${CLEAN_PATH}_" >> $GITHUB_ENV
                
                # νμΌ λ‚΄μ© μ „μ²΄λ¥Ό κ°€μ Έμ™€μ„ μ²« μ¤„(μ λ©)μ„ μ μ™Έν•κ³  μ¶λ ¥
                echo "> $(tail -n +2 "$file")" | sed 's/^/> /' >> $GITHUB_ENV
                echo "" >> $GITHUB_ENV
              fi
            done <<< "$CHANGES"
            # λ©€ν‹°λΌμΈ ν™κ²½λ³€μ μΆ…λ£
            echo "EOF" >> $GITHUB_ENV
          else
            # λ³€κ²½λ νμΌμ΄ μ—†λ” κ²½μ°
            echo "SUMMARY=μ¤λμ€ μƒλ΅μ΄ TILμ΄ μ—†μµλ‹λ‹¤. π…" >> $GITHUB_ENV
          fi

      # SlackμΌλ΅ μ”μ•½ μ „μ†΅
      - name: Send summary to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # curlμ„ μ‚¬μ©ν•μ—¬ Slack webhookμΌλ΅ λ©”μ‹μ§€ μ „μ†΅
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"${{ env.SUMMARY }}\"
            }" \
            $SLACK_WEBHOOK_URL