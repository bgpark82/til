# Retrieval

## RAG (Retrieval-Augmented Generation)
- 파인튜닝: 외부 데이터를 활용해서 모델을 학습시키는 것 (학습을 위한 GPU 비용 많이 듦)
- RAG: 외부 데이터를 활용해서 모델을 튜닝하는 것
- 둘 다 모두 LLM이 가지지 않은 지식을 포함해서 답변하도록 하는 프레임워크
- 외부데이터의 문장을 참고하여 답변

![rag](./rag.png)



## Retrieval
![retrieval](./retrieval.png)
1. Document Loader: 문서를 로드하는 것
2. Text Splitter: 문서를 분할하는 것
3. Vector Store: 문서를 벡터로 변환하는 것
4. Retrieval: 사용자 질문과 유사한 문장을 검색하는 것
5. Chain: 검색한 문장을 기반으로 유사 문자을 출력하는 것 



![document-loader](./document-loader.png)
1. page content: 문서의 내용을 가져오는 것
2. metadata: 문서의 메타데이터를 가져오는 것 (문서 위치, 제목, 페이지 넘버)

- answer: 문서의 내용을 가져오는 것 (page content)
- sources: 답변의 출처, (metadata) (LLM이 어떤 문서를 참고했는지 직접 확인)


# 질문
retriver는 질문과 유사한 데이터가 벡터 db에 없다면 유사도가 높은 관련없는 값만 가져와서 답변으로 만들어주는건가?
- 문장을 조합해서 처리
    1. Retrieval (검색): 벡터DB, 데이터 소스에서 관련 정보 가져옴
    2. Generation (생성):
        - 유사도로 가져온 상위 N개의 문장을 조회
        ```
        [2023년 매출 성장률은 12%였다. 2022년 대비 성장률은 증가했다.]
        ```
        - LLM에게 Context로 전달
        ```
        Context: 2023년 매출 성장률은 12%였다. 2022년 대비 성장률은 증가했다.
        Question: 2023년 매출 성장률이 어떻게 돼?
        Answer:
        ```
        -  컨택스트 + 질문을 LLM에 전달하면 답변을 해줌

LLM이 컨텍스트 안에서 질문에 맞는 정보를 찾아서 어떻게 자연스러운 문장으로 조합하지?
- Attention 메커니즘 + 확률적 단어 생성
    - LLM은 전달된 컨텍스트를 토큰 시퀀스로 변환
        ```
    [Context] 2023년 매출 성장률은 12%였다. [Question] 2023년 매출 성장률이 어떻게 돼? [Answer]
        ```
    - Answer에 들어갈 단어를 하나씩 생성
1. Attention 메커니즘
    - 어떤 단어에 집중할지 결정
    - LLM은 컨텍스트내 모든 단어에 유사도 계산
    ```
    "2023년 매출 성장률은 12%였다." → 높은 가중치  
    "2022년 대비 성장률은 증가했다." → 상대적으로 낮은 가중치  
    ```
2. 확률적 단어 계산 or 확률 분포 계산 
    - Attention 결과를 바탕으로 다음에 나올 단어의 확률 분포 계산
    ```
    "12%" → 90%  
    "15%" → 5%  
    "모름" → 5%  
    ```
    - 확률이 가장 높은 단어 선택, 혹은 무작위로 추가해 자연스러운 문장 생성
    - Softmax 함수를 통해 확률 분포 계산
        - 0~1사이 값으로 변환하여 정규화
3. 단어 생성 (Token Sampling)
    - 가장 확률이 높은 단어를 고르거나 무작위로 추가해 자연스러운 문장 생성
    - Greedy Search: 가장 확률이 높은 단어 선택
    - Top-k Sampling: 상위 k개의 단어 중 무작위로 선택
    - Temperature Sampling: 확률 분포 조정
        - 0~1사이 값으로 변환하여 정규화
        - 0에 가까울수록 확률이 높은 단어 선택
        - 1에 가까울수록 무작위로 선택
    - Beam Search: 여러 개의 단어 조합 시도